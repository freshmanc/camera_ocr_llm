# 网页与手机端架构设计（轻量化前后端分离）

## 1. 目标

- **网页**：浏览器访问，轻量前端（少量 HTML/CSS/JS），响应式布局。
- **iPhone/手机**：同一套 Web 或 PWA，移动端优先样式，尽量不单独维护原生 App。
- **后端**：复用现有 OCR、LLM、TTS、法语教学等能力，通过 HTTP/WebSocket 对外提供服务。

---

## 2. 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           轻量前端（仅 UI + 调用 API）                          │
├────────────────────────────┬────────────────────────────┬────────────────────┤
│  桌面浏览器                  │  手机浏览器 / PWA           │  现有桌面端（可选保留）  │
│  - 单页或少量页面             │  - 同一套前端，移动端 CSS    │  - main.py + Tk + OpenCV │
│  - 拍照/上传图 → 识别        │  - 拍照/选图 → 识别         │  - 直接读摄像头          │
│  - 输入/语音 → 对话          │  - 语音/打字 → 对话         │  - 本地窗口              │
└────────────────────────────┴────────────────────────────┴────────────────────┘
         │                              │                            │
         │  HTTPS / WSS                  │  HTTPS / WSS               │ 本地进程内
         ▼                              ▼                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           统一 API 层（建议 FastAPI）                         │
│  REST:  /api/recognize, /api/chat, /api/tts, /api/exam/...                    │
│  流式:  /api/chat/stream (SSE) 或 WebSocket /ws/chat                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心服务层（复用现有 Python 代码）                    │
│  - tools/ocr_engine.py     → 截图/图片 OCR + LLM 纠错                         │
│  - agents/voice_assistant_agent.py → 对话、法语教学、意图                        │
│  - agents/tts_agent.py     → TTS 生成音频                                     │
│  - agents/exam_agent.py    → 出卷、批改                                        │
│  - agents/learning_context.py → 学情记录                                       │
│  - config/__init__.py      → 配置不变                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 后端设计（轻量）

### 3.1 技术选型

- **框架**：FastAPI（异步、自动 OpenAPI、易挂 SSE/WebSocket）。
- **部署**：单进程 + 多 worker（如 uvicorn），OCR/LLM 仍在同一进程内调用，避免多进程间传大图。
- **与现有代码关系**：不重写 `ocr_engine`、`llm_correct`、`voice_assistant_agent` 等，仅包一层 HTTP 接口。

### 3.2 建议目录结构

```
camera_ocr_llm/
├── main.py                 # 现有桌面入口（保留）
├── worker.py
├── shared_state.py
├── config/
├── agents/
├── tools/
├── server/                 # 新增：Web/手机用后端
│   ├── __init__.py
│   ├── main.py             # FastAPI app，挂路由
│   ├── routes/
│   │   ├── recognize.py    # 图片 OCR+LLM
│   │   ├── chat.py         # 对话、流式
│   │   ├── tts.py          # 文本转语音
│   │   └── exam.py         # 出卷、批改（可选）
│   └── deps.py             # 依赖（如 get_ocr_engine）
├── web/                    # 新增：轻量网页前端
│   ├── index.html          # 单页入口
│   ├── app.js              # 少量 JS，调用 API
│   ├── style.css            # 桌面 + 移动端响应式
│   └── pwa/                # 可选 PWA：manifest.json, sw.js
└── docs/
```

### 3.3 核心 API 设计（REST，轻量）

| 接口 | 方法 | 说明 | 前端用途 |
|------|------|------|----------|
| `/api/health` | GET | 健康检查 | 检测后端是否可用 |
| `/api/recognize` | POST | 上传图片，返回 OCR + LLM 校验结果 | 拍照/选图识别 |
| `/api/chat` | POST | 发送一条消息，返回助手回复（非流式） | 简单对话 |
| `/api/chat/stream` | POST 或 GET + SSE | 发送消息，流式返回回复 | 打字/语音后边收边显示 |
| `/api/tts` | POST | 文本 → 音频文件 URL 或 base64 | 朗读、读音 |
| `/api/exam/generate` | POST | 根据文本/上传内容出卷 | 网页端出卷 |
| `/api/exam/grade` | POST | 提交答案，返回批改结果 | 网页端批改 |

- **认证**（可选）：若部署到公网，可加 API Key 或简单 Token，避免裸奔；内网可先不加密。
- **跨域**：后端配置 CORS，允许前端域名或 `*`（仅内网时）。

---

## 4. 前端设计（网页 + 手机轻量化）

### 4.1 原则

- **轻量**：尽量单页 + 少量 JS，不强制 React/Vue；若后续功能多再考虑小框架。
- **响应式**：一套 HTML/CSS，用 media query 区分桌面/手机，手机端大按钮、单栏布局。
- **与后端解耦**：所有能力通过 API 调用，前端不关心 OCR/LLM 实现。

### 4.2 页面结构建议（单页即可）

- **顶部**：标题 + 可选「当前识别结果」一行（来自上次 /recognize 或 /chat 上下文）。
- **中间**：对话列表（与现有助手类似），支持流式逐字显示。
- **底部**：
  - 输入框 + 发送；
  - 「拍照/选图」→ 调 `/api/recognize`，结果进对话或显示在「当前识别」；
  - 可选「语音」：浏览器录音 → 先 ASR（可后端再挂一个 /api/asr）或先用 Web Speech API 简单识别 → 再调 /api/chat。

### 4.3 手机端特别处理

- viewport、字体大小、可点击区域做大，避免误触。
- 拍照：`<input type="file" accept="image/*" capture="environment">` 或使用 Web API 调起相机。
- 若需「像 App 一样」：同一套 Web 加 PWA（manifest + Service Worker），支持「添加到主屏幕」、离线提示页即可，无需单独开发 iOS App。

### 4.4 流式回复（轻量实现）

- 后端：FastAPI 用 `StreamingResponse` + SSE（`text/event-stream`），每生成一段就 `data: {...}\n\n`。
- 前端：`EventSource` 或 `fetch` + 读 body 流，拼接到当前回复气泡，无需整页刷新。

---

## 5. 数据流示例

### 5.1 拍照/选图识别（网页或手机）

1. 用户点击「拍照/选图」→ 选择文件或调起相机。
2. 前端将图片转为 FormData 或 base64，POST 到 `/api/recognize`。
3. 后端：接收图片 → 调用现有 `run_ocr` + `correct_with_llm`（或封装好的单次识别函数）→ 返回 `{ raw_ocr, corrected, confidence, ... }`。
4. 前端：将「校验后」文本显示在「当前识别」或插入一条助手消息。

### 5.2 对话（含流式）

1. 用户输入或语音转文字后，带上下文（如最近 N 条）POST 到 `/api/chat/stream`。
2. 后端：调用现有 `chat_direct_llm_stream`，按 chunk 写入 SSE。
3. 前端：读 SSE，逐段追加到当前回复，直到结束。

### 5.3 TTS 朗读

1. 前端 POST 文本到 `/api/tts`，后端用现有 `generate_tts_file` 生成音频，返回 URL 或 base64。
2. 前端用 `<audio src="...">` 或 Audio 对象播放。

---

## 6. 与现有桌面端的关系

- **保留**：`main.py` + Tk + OpenCV 的桌面流程不变，适合本机摄像头、本地窗口、无需浏览器。
- **共享**：`config`、`agents`、`tools` 下所有模块被桌面和 server 共用；仅入口不同（桌面 = main.py，Web/手机 = server/main.py + web/）。
- **可选**：后续若希望「桌面端也走后端」，可让桌面端只做 UI，通过 localhost 调同一套 API，实现「一套后端、多端 UI」。

---

## 7. 实施阶段建议

| 阶段 | 内容 | 产出 |
|------|------|------|
| 1 | 新建 `server/`，FastAPI 挂 `/api/health`、`/api/recognize`（图片 → OCR+LLM） | 后端可单独测 |
| 2 | 新建 `web/`：单页 + 选图/上传 + 调 recognize，展示结果 | 网页可识别 |
| 3 | 加 `/api/chat`、`/api/chat/stream`，前端对话区 + 流式 | 网页可对话 |
| 4 | 加 `/api/tts`，前端朗读按钮 | 网页可听 |
| 5 | 响应式 CSS + 手机端优化 + 可选 PWA | 手机浏览器可用 |
| 6 | 出卷/批改等按需挂到 `/api/exam/*` | 与现有 exam_agent 对齐 |

这样可以在不大改现有架构的前提下，逐步支持网页和 iPhone 轻量访问，前后端都保持轻量化。

---

## 8. 服务器启停与管理界面（是否需要？）

**结论：需要。** 改造成「Web + iPhone + 语音助手桌面」后，网页和手机都要访问同一台机器上的 API 服务；这台服务需要有人来**启动、停止、查看状态**，否则要么一直开着一个黑窗口（run_server.bat），要么不知道服务有没有在跑、端口是多少。

### 8.1 为什么需要统一管理

- **Web / iPhone**：必须有一台「API 服务器」在跑（例如 `uvicorn server.main:app`），否则浏览器和手机连不上。
- **桌面端**：跑 `main.py` 即可，不依赖该服务器；但若希望「一个入口管全部」，就需要在桌面里能启停服务器。
- 若没有管理界面：用户只能手动开/关 `run_server.bat` 或命令行，不知道当前是运行中还是已停，也不知道本机/手机该访问哪个地址。

所以**建议有一个专门的「服务器启停/状态」入口**，用来管理「为 Web/iPhone 提供 API 的那套服务」是否在运行。

### 8.2 已实现：独立「系统管理」窗口（关本窗口 = 退出整个程序）

当前采用**独立系统管理窗口**（`tools/manager_window.py`），与语音助手窗口并存：

- **系统管理窗口**（先出现）：
  - 关闭本窗口 → 退出整个程序（含语音助手、Web 服务、主循环）。
  - **Web 服务**：状态显示、[启动] / [停止]，子进程方式拉起 `uvicorn server.main:app`。
  - 访问提示：本机 `http://127.0.0.1:8000/`，手机 `http://本机IP:8000/`。
  - **[打开语音助手]**：可再次打开已关闭的语音助手窗口。
- **语音助手窗口**：关闭仅关闭本窗口，不退出程序；需退出时请关闭「系统管理」窗口。

这样：

- **只用桌面**：不点「启动 Web 服务」即可；关语音助手不会退出，关「系统管理」才退出。
- **要用 Web/iPhone**：在系统管理窗口点「启动」，用浏览器/手机访问上述地址；点「停止」或关「系统管理」即停服务。

### 8.3 可选：独立「系统管理」小窗口

若以后希望**不打开语音助手主窗口也能启停服务**（例如只跑服务器、不跑摄像头和 Tk），可以再做一个极简的「系统管理」窗口或托盘图标，只做三件事：启动服务、停止服务、显示状态/地址。当前阶段优先把「启停 + 状态」做进语音助手窗口即可，独立管理界面可列为后续扩展。

### 8.4 小结

| 问题 | 建议 |
|------|------|
| 是否需要服务器启停界面？ | **需要**，用于管理 Web/iPhone 用的 API 服务是否在跑。 |
| 放在哪里？ | **优先放在语音助手桌面窗口**里的一块「Web 服务」区域，同一进程统一管理。 |
| 关闭桌面时？ | 若服务是由桌面进程启动的子进程，关桌面时一并结束子进程，无需再单独关一次「服务器」。 |

这样，**Web + iPhone + 语音助手桌面** 三端共用一套后端，且启停和状态都在桌面里完成，无需单独的「系统管理」程序也能管理好系统运行。
